webpackJsonp([10],{QSR2:function(e,r,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var t=s("Xxa5"),a=s.n(t),o=s("exGp"),n=s.n(o),i=s("Dd8w"),l=s.n(i),c=s("zL8q"),u=s("NYxO"),d={name:"users-view",mixins:[s("ToJ/").a],components:{"el-dialog":c.Dialog,"el-input":c.Input,"el-button":c.Button,"el-table":c.Table,"el-table-column":c.TableColumn,"el-popover":c.Popover,"el-form":c.Form,"el-form-item":c.FormItem,"el-row":c.Row,"el-col":c.Col},props:{isForChangeDefaultPwd:{type:Boolean}},data:function(){var e=this;return{changePassword:!1,dialogVisible:!1,oper:"new",users:[],record:{username:"",password:"",newPassword:"",repeatPassword:"",tags:""},rules:{username:[{required:!0,message:this.$t("users.usernameRequired")},{min:2,max:32,message:this.$t("users.usernameIllegal"),trigger:"change"}],tags:[{required:!0,message:this.$t("users.remarkRequired")}],password:[{required:!0,message:this.$t("users.passwordRequired")},{min:3,max:255,message:this.$t("users.passwordIllegal"),trigger:"change"}],newPassword:[{required:!0,message:this.$t("users.passwordRequired")},{min:3,max:255,message:this.$t("users.passwordIllegal"),trigger:"change"},{validator:function(r,s,t){s===e.record.password?t(new Error(e.$t("users.noSameNewPwd"))):t()},trigger:"blur"}],repeatPassword:[{required:!0,message:this.$t("users.passwordRequired")},{validator:function(r,s,t){s!==e.record.newPassword?t(new Error(e.$t("users.passwordInconsistent"))):t()},trigger:"change"}]}}},computed:{username:function(){return this.$store.state.user.username},currentUserName:function(){return this.$store.state.user.username}},methods:l()({},Object(u.b)(["USER_LOGIN"]),{handleOperation:function(){var e=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],s=arguments[1];this.changePassword=!1,this.dialogVisible=!0,r?(this.oper="new",this.record={username:"",password:"",newPassword:"",repeatPassword:"",tags:"viewer"},setTimeout(function(){e.$refs.record.clearValidate()},10)):(this.oper="edit",this.record=l()({},s),this.$set(this.record,"password",""))},loadData:function(){var e=this;return n()(a.a.mark(function r(){var s,t;return a.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e.$httpGet("/users");case 3:s=r.sent,t=s.data,e.users=t,r.next=11;break;case 8:r.prev=8,r.t0=r.catch(0),e.$message.error(r.t0||e.$t("error.networkError"));case 11:case"end":return r.stop()}},r,e,[[0,8]])}))()},createUser:function(){var e=this;"edit"!==this.oper?this.$refs.record.validate(function(r){r&&e.$httpPost("/users",e.record).then(function(){e.$message.success(""+e.$t("users.createUser")),e.loadData(),e.dialogVisible=!1}).catch(function(r){e.$message.error(r||e.$t("error.networkError"))})}):this.updateUser()},updateUser:function(){var e=this;this.$refs.record.validate(function(r){if(r)if(e.changePassword){var s={old_pwd:e.record.password,new_pwd:e.record.newPassword};e.$httpPut("/users/"+encodeURIComponent(e.record.username),e.record).then(function(){e.$httpPut("/change_pwd/"+encodeURIComponent(e.record.username),s).then(function(){e.$store.state.user.username===e.record.username&&e.record.password!==e.record.newPassword?(e.$message.error(e.$t("users.authenticate")),e.USER_LOGIN({isLogOut:!0}),e.$router.push("/login")):(e.$message.success(""+e.$t("oper.edit")+e.$t("alert.success")),e.dialogVisible=!1,e.loadData())}).catch(function(r){e.$message.error(r||e.$t("error.networkError"))})})}else e.$httpPut("/users/"+encodeURIComponent(e.record.username),e.record).then(function(){e.$message.success(""+e.$t("oper.edit")+e.$t("alert.success")),e.dialogVisible=!1,e.loadData()}).catch(function(r){e.$message.error(r||e.$t("error.networkError"))})})},deleteUser:function(e,r,s){var t=this;this.$httpDelete("/users/"+encodeURIComponent(e.username)).then(function(){t.$message.success(""+t.$t("oper.delete")+t.$t("alert.success")),t.loadData(),s.$refs["popover-"+r].doClose()}).catch(function(e){t.$message.error(e||t.$t("error.networkError"))})},openChangePwdDialog:function(){var e=this;try{var r=this.users.find(function(r){return r.username===e.currentUserName});if(!r)throw new Error("User not found");this.handleOperation(!1,r),this.changePassword=!0}catch(e){console.error(e)}},confirmForChangeDefaultPwdParam:function(){this.isForChangeDefaultPwd&&this.openChangePwdDialog()}}),watch:{isForChangeDefaultPwd:function(e){e&&this.openChangePwdDialog()}},created:function(){var e=this;return n()(a.a.mark(function r(){return a.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.loadData();case 2:e.confirmForChangeDefaultPwdParam();case 3:case"end":return r.stop()}},r,e)}))()},beforeRouteLeave:function(e,r,s){this.preventLeaveWithoutChangeDefaultPwd(e,r,s)},beforeRouteUpdate:function(e,r,s){this.preventLeaveWithoutChangeDefaultPwd(e,r,s)}},p={render:function(){var e=this,r=e.$createElement,s=e._self._c||r;return s("div",{staticClass:"users-view"},[s("div",{staticClass:"page-title"},[e._v("\n    "+e._s(e.$t("leftbar.users"))+"\n    "),s("el-button",{staticClass:"confirm-btn",staticStyle:{float:"right"},attrs:{round:"",plain:"",type:"success",icon:"el-icon-plus",size:"medium",disabled:e.$store.state.loading},on:{click:function(r){return e.handleOperation(!0)}}},[e._v("\n      "+e._s(e.$t("users.newUser"))+"\n    ")])],1),e._v(" "),s("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.$store.state.loading,expression:"$store.state.loading"}],attrs:{border:"",data:e.users}},[s("el-table-column",{attrs:{prop:"username",label:e.$t("users.username")}}),e._v(" "),s("el-table-column",{attrs:{prop:"tags",label:e.$t("users.remark")}}),e._v(" "),s("el-table-column",{attrs:{width:"140",label:e.$t("oper.oper")},scopedSlots:e._u([{key:"default",fn:function(r){var t=r.row,a=r.$index,o=r._self;return[s("el-button",{attrs:{size:"mini",type:"warning",plain:""},on:{click:function(r){return e.handleOperation(!1,t)}}},[e._v("\n          "+e._s(e.$t("oper.edit"))+"\n        ")]),e._v(" "),s("el-popover",{ref:"popover-"+a,attrs:{placement:"right",trigger:"click"}},[s("p",[e._v(e._s(e.$t("oper.confirmDelete")))]),e._v(" "),s("div",{staticStyle:{"text-align":"right"}},[s("el-button",{staticClass:"cache-btn",attrs:{size:"mini",type:"text"},on:{click:function(e){o.$refs["popover-"+a].doClose()}}},[e._v("\n              "+e._s(e.$t("oper.cancel"))+"\n            ")]),e._v(" "),s("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(r){return e.deleteUser(t,a,o)}}},[e._v("\n              "+e._s(e.$t("oper.confirm"))+"\n            ")])],1),e._v(" "),s("el-button",{directives:[{name:"show",rawName:"v-show",value:"admin"!==t.username&&e.username!==t.username,expression:"row.username !== 'admin' && username !== row.username"}],attrs:{slot:"reference",size:"mini",type:"danger",plain:""},slot:"reference"},[e._v("\n            "+e._s(e.$t("oper.delete"))+"\n          ")])],1)]}}])})],1),e._v(" "),s("el-dialog",{attrs:{width:"500px",visible:e.dialogVisible,title:"new"===e.oper?e.$t("users.newUser"):e.$t("users.editUser"),"show-close":!e.isForChangeDefaultPwd,"close-on-click-modal":!e.isForChangeDefaultPwd,"close-on-press-escape":!e.isForChangeDefaultPwd},on:{"update:visible":function(r){e.dialogVisible=r}},nativeOn:{keyup:function(r){return!r.type.indexOf("key")&&e._k(r.keyCode,"enter",13,r.key,"Enter")?null:e.createUser.apply(null,arguments)}}},[s("el-form",{ref:"record",staticClass:"el-form--public",attrs:{"label-position":"top",size:"medium",model:e.record,rules:e.rules}},[s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"username",label:e.$t("users.username")}},[s("el-input",{attrs:{disabled:"edit"===e.oper},model:{value:e.record.username,callback:function(r){e.$set(e.record,"username",r)},expression:"record.username"}})],1)],1),e._v(" "),"new"===e.oper?s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"password",label:e.$t("users.password")}},[s("el-input",{attrs:{type:"password"},model:{value:e.record.password,callback:function(r){e.$set(e.record,"password",r)},expression:"record.password"}})],1)],1):e._e(),e._v(" "),e.changePassword&&"edit"===e.oper?s("div",[s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"password",label:e.$t("users.oldPassword")}},[s("el-input",{attrs:{type:"password"},model:{value:e.record.password,callback:function(r){e.$set(e.record,"password",r)},expression:"record.password"}})],1)],1),e._v(" "),s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"newPassword",label:e.$t("users.newPassword")}},[s("el-input",{attrs:{type:"password"},model:{value:e.record.newPassword,callback:function(r){e.$set(e.record,"newPassword",r)},expression:"record.newPassword"}})],1)],1),e._v(" "),s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"repeatPassword",label:e.$t("users.confirmNewPassword")}},[s("el-input",{attrs:{type:"password"},model:{value:e.record.repeatPassword,callback:function(r){e.$set(e.record,"repeatPassword",r)},expression:"record.repeatPassword"}})],1)],1)],1):e._e(),e._v(" "),s("el-col",{attrs:{span:24}},[s("el-form-item",{attrs:{prop:"tags",label:e.$t("users.remark")}},[s("el-input",{model:{value:e.record.tags,callback:function(r){e.$set(e.record,"tags",r)},expression:"record.tags"}})],1)],1),e._v(" "),s("el-col",{attrs:{span:24}},[s("el-form-item",["edit"!==e.oper||e.isForChangeDefaultPwd?e._e():s("el-button",{staticClass:"cache-btn change-password",attrs:{type:"text"},on:{click:function(r){e.changePassword=!e.changePassword}}},[e._v("\n              "+e._s(e.changePassword?e.$t("users.dontChangePassword"):e.$t("users.changePassword"))+"\n            ")])],1)],1)],1)],1),e._v(" "),s("div",{attrs:{slot:"footer"},slot:"footer"},[e.isForChangeDefaultPwd?e._e():s("el-button",{staticClass:"cache-btn",attrs:{type:"text"},on:{click:function(r){e.dialogVisible=!1}}},[e._v("\n        "+e._s(e.$t("oper.cancel"))+"\n      ")]),e._v(" "),s("el-button",{staticClass:"confirm-btn",attrs:{type:"success",loading:e.$store.state.loading},on:{click:e.createUser}},[e._v("\n        "+e._s(e.$t("oper.save"))+"\n      ")])],1)],1)],1)},staticRenderFns:[]};var m=s("VU/8")(d,p,!1,function(e){s("UfF/")},null,null);r.default=m.exports},"ToJ/":function(e,r,s){"use strict";r.a={methods:{preventLeaveWithoutChangeDefaultPwd:function(e,r,s){var t=e.name,a=void 0===t?"":t,o=e.params,n=void 0===o?{}:o;!this.$store.state.user.isUsingDefaultPwd||"users"===a&&!0===n.isForChangeDefaultPwd?s():s({name:"users",params:{isForChangeDefaultPwd:!0},query:{_t:Date.now()}})}}}},"UfF/":function(e,r){}});